---
title: åœ¨Androidä¸­ä½¿ç”¨Java8è¯­æ³•ç‰¹æ€§
date: 2019-11-30
update: 2019-11-30
comments: true
tags: [Android, Java]
categories: Android
id: use-java8-features-in-android
---

å¯ä»¥åœ¨ Android åŸç”Ÿå¼€å‘ä¸­å†™ Lambda äº†ï¼Œç®€ç›´ä¸è¦å¤ªèˆ’æœå¥½å§ ğŸš€

<!---more--->



### Android and Java

Java åœ¨ Android çš„å¿«é€Ÿå‘å±•ä¸­æ‰®æ¼”ç€éå¸¸é‡è¦çš„è§’è‰²ï¼Œå¼€å‘è¯­è¨€æ˜¯ Javaï¼ŒFramework æ¡†æ¶ï¼ˆå³ Android SDKï¼‰ï¼Œå¼•ç”¨äº† 80% çš„ JDK-APIï¼Œå¼€å‘å·¥å…· Android Studio æ˜¯åŸºäº Java å¼€å‘å·¥å…· IDEA äºŒæ¬¡å¼€å‘å®Œæˆçš„ï¼Œè¿™äº›å’Œ Java éƒ½æœ‰ç€åƒä¸ä¸‡ç¼•çš„å…³ç³»

ä½†æ˜¯å¯èƒ½æ˜¯å—åˆ°ä¸ Oracle å…¬å¸æ³•å¾‹è¯‰è®¼çš„å½±å“ï¼ŒGoogle åœ¨ Android ä¸Šé’ˆå¯¹ Java çš„å‡çº§ä¸€ç›´éƒ½ä¸æ˜¯å¾ˆç§¯æ

- Java7 ï¼ˆ2011.07ï¼‰
  - Android ä»1.0 ä¸€ç›´å‡çº§åˆ°4.4ï¼Œè¿­ä»£äº†å°†è¿‘19ä¸ªAndroidç‰ˆæœ¬ï¼Œæ‰åœ¨4.4ç‰ˆæœ¬ä¸­æ”¯æŒäº†Java 7
- Java8 ï¼ˆ2014.03ï¼‰
  - RetraLambda æ’ä»¶
  - ç„¶åä» Android 4.4 ç‰ˆæœ¬å¼€å§‹ç®—èµ·ï¼Œä¸€ç›´åˆ° Android N(7.0) å…±4ä¸ª Android ç‰ˆæœ¬ï¼Œæ‰åœ¨ Jack/Jill å·¥å…·é“¾å‹‰å¼ºæ”¯æŒäº†Java 8ã€‚ä½†ç”±äº Jack/Jill å·¥å…·é“¾åœ¨æ„å»ºæµç¨‹ä¸­èˆå¼ƒäº†åŸæœ‰ Java å­—èŠ‚ç çš„ä½“ç³»ï¼Œå¯¼è‡´å¤§é‡æ—¢æœ‰çš„æŠ€æœ¯æ²‰æ·€æ— æ³•åº”ç”¨ï¼Œè‡´ä½¿è®¸å¤š App å·¥ç¨‹æ”¾å¼ƒäº†æ¥å…¥
  - æœ€åç›´åˆ° Android P(9.0) ç‰ˆæœ¬ï¼Œ Google æ‰åœ¨ Android Studio 3.x ä¸­é€šè¿‡æ–°å¢çš„ D8 dex ç¼–è¯‘å™¨æ­£å¼æ”¯æŒäº† Java 8ï¼Œä½†éƒ¨åˆ† API å¹¶ä¸èƒ½å…¨ç‰ˆæœ¬æ”¯æŒ

### Java8 new features overview

Java8 æ˜¯ Java éå¸¸é‡è¦çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œä»è¿™ä¸ªç‰ˆæœ¬å¼€å§‹ï¼ŒJava å¼€å¯æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹ã€‚ä¹Ÿå¸æ”¶äº†è¿è¡Œåœ¨JVMä¸Šçš„ Groovyã€Scala è¿™ç§åŠ¨æ€è„šæœ¬è¯­è¨€çš„ç‰¹æ€§åï¼ŒJava8 åœ¨è¯­è¨€çš„è¡¨è¾¾åŠ›ã€ç®€æ´æ€§ä¼˜è‰¯å¾ˆå¤§çš„æé«˜

Java8 çš„ä¸»è¦è¯­è¨€ç‰¹æ€§æ”¹è¿›æ¦‚æ‹¬èµ·æ¥åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ï¼š

- **Lambda expression** - Lambda è¡¨è¾¾å¼
- **Method reference** - æ–¹æ³•ç›´æ¥å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°å¼æ¥å£
- **Default method** - æŠ½è±¡æ¥å£ä¸­å…è®¸ä½¿ç”¨ default å…³é”®å­—ï¼Œæ¥å®šä¹‰éæŠ½è±¡æ–¹æ³•
- **Repeating annotation** - å¯é‡å¤ä½¿ç”¨æ³¨è§£
- **Stream API** - é€šè¿‡æµå¼è°ƒç”¨æ”¯æŒ mapã€filter ç­‰é«˜é˜¶å‡½æ•°
- **Date API** - æ”¹è¿›ã€æ‰©å±•äº†çš„å…³äºæ—¥æœŸå’Œæ—¶é—´çš„ API
- **New tools** - æ–°çš„å·¥å…·ï¼Œæ¯”å¦‚åˆ†æå™¨ã€å¼•æ“ï¼ˆNashorn å¼•æ“ jjsã€ ç±»ä¾èµ–åˆ†æå™¨ jdepsï¼‰
- **Optional** - ç”¨æ¥è§£å†³ç©ºæŒ‡é’ˆå¼‚å¸¸çš„ Optional ç±»
- **Nashorn, JavaScript Engine** - å¢åŠ äº†ä¸€ä¸ª JS å¼•æ“ï¼Œå…è®¸åœ¨ JVM ä¸Šè¿è¡Œç‰¹å®šçš„ js ç¨‹åº

> æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ Java8 è¯­æ³•ç‰¹æ€§æ˜¯å¦‚ä½•åœ¨ JVM ä¸Šå·¥ä½œçš„ï¼Œä»¥ Lambda è¡¨è¾¾å¼ä¸ºä¾‹

### Lambda expression

Lambda è¡¨è¾¾å¼ä¸»è¦ç”¨æ¥å®šä¹‰è¡Œå†…æ‰§è¡Œçš„æ–¹æ³•ç±»å‹æ¥å£ï¼Œå¦‚ä¸€ä¸ªç®€å•çš„**å‡½æ•°å¼æ¥å£**ï¼Œå®ƒå…å»äº†ä½¿ç”¨åŒ¿åæ–¹æ³•çš„éº»çƒ¦ï¼Œå¹¶ä¸”ç»™äºˆ Java ç®€å•ä½†æ˜¯å¼ºå¤§çš„å‡½æ•°åŒ–ç¼–ç¨‹èƒ½åŠ›ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š

- `(parameters) -> expression`
- `(parameters) -> {statements;}`

> å‡½æ•°å¼æ¥å£ï¼šJava8 å¯¹ä¸€ç±»ç‰¹æ®Šç±»å‹æ¥å£çš„ç§°å‘¼ï¼Œè¿™ç±»æ¥å£åªå®šä¹‰äº†é™¤äº† Object å¯¹è±¡å…¬å…±æ–¹æ³•å¤–çš„å”¯ä¸€çš„æŠ½è±¡æ–¹æ³•çš„æ¥å£
>
> ä¸ºä»€ä¹ˆå®šä¹‰æ­¤æ¥å£ï¼Ÿä¸æƒ³ä¸º Lambda è¡¨è¾¾å¼å•ç‹¬å®šä¹‰ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°ç±»å‹ï¼Œæ¯”å¦‚ç®­å¤´ç±»å‹ï¼Œæƒ³é‡‡ç”¨ Java ç°æœ‰çš„ç±»å‹ç³»ç»Ÿï¼Œé¿å…å¢åŠ ä¸€ä¸ªç»“æ„åŒ–å‡½æ•°ç±»å‹æ¥å¢åŠ å¤æ‚æ€§

æ¯”å¦‚æˆ‘ä»¬å†™äº†è¿™æ ·çš„ä¸€ä¸ªåŒ…å« Lambda è¡¨è¾¾å¼çš„ demoï¼š

```java
public class HelloLambda {

    public static void main(String[] args) {
        new Thread(() -> System.out.println("hello")).start();
    }

}
```

ä½¿ç”¨  `javac HelloLambda.java` å‘½ä»¤ç¼–è¯‘ï¼Œç»“æœå¦‚ä¸‹

<img src="/images/image-20191231142159833.png" alt="image-20191231142159833" style="zoom: 50%;" />

å¯ä»¥çœ‹åˆ°è¿˜æ˜¯æœ‰ç®­å¤´ç¬¦å·çš„ï¼Œä½¿ç”¨ `javap -c -p HelloLambda` å‘½ä»¤è¿›è¡Œåæ±‡ç¼–ï¼Œç»“æœå¦‚ä¸‹

<img src="/images/image-20191231142429303.png" alt="image-20191231142429303" style="zoom: 50%;" />

å¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ä¸€æ¡ `invokedynamic` è°ƒç”¨æ–¹æ³•æŒ‡ä»¤ï¼Œæˆ‘ä»¬çŸ¥é“ JVM ä¸­è°ƒç”¨æ–¹æ³•ä¸€å…±æœ‰äº”ç§æŒ‡ä»¤ï¼Œå…¶ä½™å››ç§ä¸ºï¼š

- `invokestatic` - è°ƒç”¨é™æ€æ–¹æ³•
- `invokespecial` - è°ƒç”¨ç§æœ‰æ–¹æ³•ã€çˆ¶ç±»æ–¹æ³•ã€ç±»æ„é€ å™¨æ–¹æ³•
- `invokeinterface` - è°ƒç”¨æ¥å£æ–¹æ³•
- `invokevirtual` - è°ƒç”¨éœ€æ–¹æ³•ï¼ˆé™¤äº†ä»¥ä¸Šä»¥å¤–çš„æ–¹æ³•ï¼‰

è¿™å››ç§æŒ‡ä»¤ï¼Œéƒ½æ˜¯åœ¨å˜å¼‚æœŸé—´ç”Ÿæˆçš„ class æ–‡ä»¶ä¸­ï¼Œé€šè¿‡å¸¸é‡æ±  Constant Pool çš„ MethodRef å¸¸é‡å·²ç»å›ºå®šäº†ç›®æ ‡æ–¹æ³•çš„ç¬¦å·ä¿¡æ¯ï¼ˆæ–¹æ³•æ‰€å±è€…åŠå…¶ç±»å‹ã€æ–¹æ³•åå­—ã€å‚æ•°é¡ºåºå’Œç±»å‹ã€è¿”å›å€¼ï¼‰ï¼Œè™šæ‹Ÿæœºä½¿ç”¨ç¬¦å·ä¿¡æ¯èƒ½ç›´æ¥è§£é‡Šå‡ºå…·ä½“çš„æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨

- `invokedynamic` - åŠ¨æ€æ‰§è¡Œæ–¹æ³•

> é‚£ä¹ˆï¼Œ`invokedynamic` æ˜¯å¦‚ä½•é€šè¿‡å¼•å¯¼æ–¹æ³•æ‰¾åˆ°æ‰€å±è€…åŠå…¶ç±»å‹çš„å‘¢ï¼Ÿ

ä½¿ç”¨ `javap  -v HelloLambda.class` æŸ¥çœ‹æœ¬åœ°å˜é‡è¡¨ï¼Œç»“æœå¦‚ä¸‹

<img src="/images/image-20191231142628776.png" alt="image-20191231142628776" style="zoom:50%;" />

å¯¹åº”åˆ°äº†å¸¸é‡æ± ä¸­è¿™ä¸€æ¡æ•°æ®ï¼Œæ³¨æ„å¸¸é‡æ± ä¸­çš„ `InvokeDynamic` ä¸æ˜¯æŒ‡ä»¤ï¼Œä»£è¡¨çš„æ˜¯ `Constant InvokeDynamic Info`ç»“æ„ï¼Œåé¢ç´§è·Ÿçš„ `#0` æ ‡è¯†çš„æ˜¯ `BootstrapMethod` åŒºåŸŸä¸­å¼•å¯¼æ–¹æ³•çš„ç´¢å¼•ï¼š

<img src="/images/image-20191231142732850.png" alt="image-20191231142732850" style="zoom:50%;" />

å¯ä»¥å‘ç°å¼•å¯¼æ–¹æ³•ä¸­çš„  `java/lang/invoke/LambdaMetafactory.metafactory`ï¼Œæ‰æ˜¯ `invokedynamic` æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å…³é”®æ­¥éª¤ï¼Œæºç å¦‚ä¸‹ï¼š

<img src="/images/image-20191231142827188.png" alt="image-20191231142827188" style="zoom: 45%;" />

<img src="/images/image-20191231142922291.png" alt="image-20191231142922291" style="zoom:45%;" />

å¯ä»¥å‘ç°ï¼Œæ‰§è¡Œè¯¥æ–¹æ³•ï¼Œä¼šåœ¨å†…å­˜ä¸­åŠ¨æ€ç”Ÿæˆä¸€ä¸ªå®ç° Lambda è¡¨è¾¾å¼å¯¹åº”å‡½æ•°å¼æ¥å£çš„å®ä¾‹ç±»å‹ï¼Œå¹¶åœ¨æ¥å£çš„å®ç°æ–¹æ³•ä¸­è°ƒç”¨æ–°å¢çš„é™æ€ç§æœ‰æ–¹æ³•

è¿è¡Œ `java -Djdk.internal.lambda.dumpProxyClasses HelloLambda.class`ï¼Œå°†å†…å­˜ä¸­åŠ¨æ€ç”Ÿæˆçš„ç±»å‹è¾“å‡ºåˆ°æœ¬åœ°ï¼ˆâš ï¸ éœ€è¦åœ¨é¡¹ç›®æ ¹ç›®å½• src ä¸‹æ‰§è¡Œæ­¤å‘½ä»¤ï¼‰

<img src="/images/image-20191231143117751.png" alt="image-20191231143117751" style="zoom:50%;" />

è¿è¡Œ `javap -p -c HelloLambda\$\$Lambda\$1` åç¼–è¯‘ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆç´¯çš„å®ç°ä¸º

<img src="/images/image-20191231143229176.png" alt="image-20191231143229176" style="zoom:45%;" />

åœ¨ run æ–¹æ³•ä¸­ä½¿ç”¨äº† invokestatic æŒ‡ä»¤ï¼Œç›´æ¥è°ƒç”¨äº† `HelloLambda.lambda\$main\$0` è¿™ä¸ªåœ¨ç¼–è¯‘æœŸé—´ç”Ÿæˆçš„é™æ€ç§æœ‰æ–¹æ³•

> è‡³æ­¤ï¼Œä»¥ä¸Šå°±æ˜¯ Lambda è¡¨è¾¾å¼åœ¨ Java åº•å±‚çš„å®ç°åŸç†ï¼Œé‚£ä¹ˆåœ¨ Android ä¸­ï¼Œæ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ

### Run directly on Android?

Java Bytecode, JVM å­—èŠ‚ç ï¼Œæ˜¯ä¸èƒ½ç›´æ¥è¿è¡Œåœ¨ Android ç³»ç»Ÿä¸Šçš„ï¼Œéœ€è¦è½¬æ¢æˆ Android Bytecodeï¼Œä¹Ÿå°±æ˜¯ Dalvik / ART å­—èŠ‚ç 

![image-20191231104544007](/images/image-20191231104544007.png)

### Android support indirectly

å› æ­¤ Android è¿›è¡Œäº†é—´æ¥æ”¯æŒï¼Œåœ¨ Java å­—èŠ‚ç è½¬æ¢åˆ° Android å­—èŠ‚ç çš„è¿‡ç¨‹ä¸­å¢åŠ ä¸€ä¸ªæ­¥éª¤ï¼ŒæŠŠå­—èŠ‚æ¢è½¬æ¢ä¸º Android è™šæ‹Ÿæœºæ”¯æŒçš„å­—èŠ‚ç ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç§°ä¸º **è„±ç³– (Desugar)**

![image-20191231104735897](/images/image-20191231104735897.png)

æ— è®ºæ˜¯ä¹‹å‰çš„ Jack & Jill å·¥å…·ï¼Œè¿˜æ˜¯ç°åœ¨çš„ D8 dex ç¼–è¯‘å™¨ï¼Œå¤„ç†æ–¹å¼éƒ½æ˜¯ç±»ä¼¼çš„ï¼šåœ¨æµç¨‹ä¸Šï¼Œå¢åŠ è„±ç³–çš„è¿‡ç¨‹ï¼›åœ¨åŸç†ä¸Šï¼Œå‚è€ƒ Lambda åœ¨ Java åº•å±‚çš„å®ç°ï¼ŒæŠŠè¿™äº›å®ç°ç§»æ¤åˆ°æ’ä»¶æˆ–ç¼–è¯‘å™¨å·¥å…·ä¸­

Android ä¸­æ”¯æŒçš„ Java8 è¯­æ³•åŒ…æ‹¬ï¼š

- Lambda expression
- Method references
- Default method
- Repeating annotation

åœ¨ D8 ç¼–è¯‘æ–¹å¼ä¸­ï¼Œè„±ç³–çš„è¿‡ç¨‹æ”¾åœ¨äº†å…¶å†…éƒ¨ï¼Œç”± Android Studio æ¥å®ç°è¿™ä¸ªè½¬æ¢ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯å‚è€ƒ `java/lang/invoke/LambdaMetafactory.metafactory` çš„æ–¹å¼å°†åŸæœ¬åœ¨è¿è¡Œæ—¶ç”Ÿæˆåœ¨å†…å­˜ä¸­çš„ç±»ï¼Œåœ¨ D8 ç¼–è¯‘ dex æœŸé—´ï¼Œç›´æ¥ç”Ÿæˆå¹¶å†™å…¥åˆ° dex æ–‡ä»¶ä¸­

å®é™…å¼€å‘ä¸­ï¼Œä¿è¯ Android Studio ç‰ˆæœ¬åœ¨ 3.0 åŠä»¥ä¸Šï¼Œåœ¨ module çš„ build.gradle æ–‡ä»¶ï¼Œåœ¨android èŠ‚ç‚¹ä¸­å¢åŠ å¦‚ä¸‹ä»£ç åï¼Œè¯¥ module å³å¯å®Œæˆå¯¹éƒ¨åˆ† Java8 è¯­æ³•ç‰¹æ€§çš„æ”¯æŒ   

```shell
compileOptions {
    sourceCompatibility JavaVersion.VERSION_1_8
    targetCompatibility JavaVersion.VERSION_1_8
}
```

å‚è€ƒï¼š [Google å®˜æ–¹æŒ‡å¯¼æ–‡æ¡£](https://developer.android.com/studio/write/java8-support?hl=zh-cn)

